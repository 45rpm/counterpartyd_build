upstream app_server_cw_api {
  server 127.0.0.1:4000; #default port
}
upstream app_server_cw_feed {
  server 127.0.0.1:4001; #default port
}
upstream app_server_cw_chat {
  server 127.0.0.1:4002; #default port
}
upstream cache_server {
  server 127.0.0.1:6379; #default port
  keepalive 128;
}

server {
  listen 80 default_server deferred;
  listen 443 default_server ssl deferred;
  client_max_body_size 4G;
  server_name _;
  
  #SSL - For production use
  #ssl_certificate      /etc/ssl/certs/counterwallet.pem;
  #ssl_certificate_key  /etc/ssl/private/counterwallet.key;
  
  #SSL - For development use
  ssl_certificate      /etc/ssl/certs/ssl-cert-snakeoil.pem;
  ssl_certificate_key  /etc/ssl/private/ssl-cert-snakeoil.key;
  
  access_log /var/log/nginx/counterwallet.access.log;
  error_log /var/log/nginx/counterwallet.error.log;

  #BASE SITE SERVING (STATIC FILES)
  location /  {
    root /home/xcp/counterwallet/build/;
  }
  
  #API REQUESTS - try to hit the cache in redis first
  location /_api
  {
    # don't cache API non-POST requests
    if ($request_method != POST)
    {
      return 550;
    }
    
    # Check if local memcached server can answer this request
    default_type text/html;

    set_sha1 $body_digest $request_body;
    set $redis_key ":1:data_$scheme://$host$request_uri::$body_digest";

    # take out the '_' query string param that jquery puts into its ajax requests if cache == false
    if ($redis_key ~ (.*)(\?|&)_=[0-9]+(.*)) {
      set $redis_key $1$3;
    }     

    add_header    X-CW-Cached  hit;
    add_header    X-CW-Cache-Key  $redis_key;

    set $redis_db "0";
    redis_pass cache_server;

    # Send to app server if Redis could not answer the request
    error_page 404 405 550 = @wsgi_api;
  }

  #WSGI TO COUNTERWALLETD API BACKEND
  location @wsgi_api {
    #X-CW-Cached will be added down at the app server
    add_header    X-CW-BackendHost $hostname;
    
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Protocol $scheme;
    proxy_redirect off;
    proxy_pass   http://app_server_cw_api;
  }

  #WSGI TO COUNTERWALLETD FEED BACKEND (sockets.io)
  location /_feed {
    add_header    X-CW-BackendHost $hostname;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Protocol $scheme;
    proxy_redirect off;
    proxy_pass   http://app_server_cw_feed;
  }

  #WSGI TO COUNTERWALLETD CHAT BACKEND (sockets.io)
  location /_chat {
    add_header    X-CW-BackendHost $hostname;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Protocol $scheme;
    proxy_redirect off;
    proxy_pass   http://app_server_cw_feed;
  }
}